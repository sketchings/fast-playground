name: "Create Release Branch"
on:
  workflow_dispatch:
    inputs:
      prefix:
        default: 'test-'
        description: 'Prefix for tag and branch'
        required: true
jobs:
  createrelease:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/setup-node@v2
      with:
        node-version: '14'
        check-latest: true
    - name: Check out code
      uses: actions/checkout@v2
      with:
        ref: develop
    - name: generate-version
      env:
        prefix: ${{ github.event.inputs.prefix }}
      run: |
        latest_tag=$(git tag --list "${prefix}*" --sort=v:refname|tail -1)
        minor_version=$(echo $latest_tag | sed -r 's#'${prefix}'[0-9]+\.([0-9]+)\.[0-9]+#\1#')
        let minor_version+=1
        new_version=$(echo $latest_tag | sed -r 's#'${prefix}'([0-9]+\.)[0-9]+\.[0-9]+#\1'${minor_version}'.0#')
        echo "new_version=$new_version" >> $GITHUB_ENV
        echo "new_branch=${prefix}$new_version" >> $GITHUB_ENV
    - name: Create release branch
      run: git checkout -b ${new_branch}
    - name: Initialize mandatory git config
      run: |
       git config user.name "GitHub Actions"
       git config user.email "alena+gha@holligan.us"
    - name: Change version number and name
      run: |
        sed -i -E "s/__version__ = '.*'/__version__ = '${{ env.new_version }}'/g" 'src/_version.py'
    - name: install jira-changelog
      run: npm install -g jira-changelog
    - name: Write chagelog
      run: |
        jira-changelog --range origin/main..${{ env.new_branch }} > chglog.md
        echo -e "RELEASE ${{ env.new_version }}\n$(cat chglog.md)" > chglog.md
    - name: Commit changelog and manifest files
      id: make-commit
      run: |
        git add src/_version.py
        git commit -F chglog.md
    - name: Push new branch
      run: git push origin ${{ env.new_branch }}
    - name: slack notification
      run: echo "send to slack"
